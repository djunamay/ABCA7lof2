\subsubsection{\underline{Single-cell Transcriptomic Data Processing}}

\paragraph{Variant calling and ROSMAP subject selection.}
A total of 36 individuals were selected from the ROSMAP cohort, a longitudinal cohort study of aging and dementia in elderly nuns, priests, and brothers. Processed whole genome sequencing (WGS) variant call files for all ROSMAP samples, where available ($N=1249$ sequencing samples), were downloaded from Synapse (syn11724057). Variant call data were downloaded for chromosomes harboring SORL1, TREM2, ABCA7, ATP8B4, ABCA1, and ADAM10 (see Github Repository). When more than one WGS sample existed for a given subject, the sample with the higher Genomic Quality Score was chosen. Only samples that did not have sex mismatches and were consistent with previous array-based genotype data were considered (see syn12178037). Only variants that passed quality control (‘FILTER_PASS’) were considered.

Potential PTC (protein-truncating) variants in each of the aforementioned genes were flagged based on the following criteria: the variant had to be either a splice, missense, frameshift, nonsense, or premature start variant and be annotated as ‘LOF’ (loss of function). For ABCA7, this filtering captured known ABCA7 LoF risk variants from the literature, except for c.5570+5G>C, which was manually added to the filtered variants. Also see syn10901595 (https://www.synapse.org/\#!Synapse:syn10901595) for information on WGS library preparation, quality control, variant annotations, and impact predictions. Annotated ABCA7 PTC variants are shown in Data~\ref{data:ptc_variants}.

The WGS data was used to identify 12 subjects who did not carry a known PTC variant in one of the aforementioned genes, other than in ABCA7, and for whom fresh-frozen postmortem tissue was available for request from Rush University (termed ‘LoF’ samples). We also selected 24 individuals who do not carry a single ABCA7 PTC mutation or PTC variants in one of the aforementioned genes (termed ‘control’ samples). Control samples were matched on age, sex, and pathology. 

\paragraph{Read Counting & Alignment.}
Library demultiplexing was performed using the BMC/BCC pipelines BioMicroCenter Software. Fast-q reads were aligned to the human genome GRCh38 and counted using the `cellranger count()` function from Cell Ranger version 6.1.2 (10x Genomics). Introns were included in counting to allow for the detection of unspliced transcripts, and the expected number of cells was set to 5000. Otherwise, Cell Ranger (v.6.1.2) default parameters were used. Counts across individual samples were then aggregated using a custom aggregation script (see GitHub Repository), resulting in a total of 150,456 cells.

\paragraph{Sample Swap Analysis.}
Sample swap analysis was performed using a previously established pipeline (MVV; QTLtools\_1.1) \supercite{Fort2017-jq}, which compares allelic concordance between genomic and transcriptomic sequencing data. As input, we used the BAM files generated in the cellranger counting step and the chromosome 19 (the chromosome harboring ABCA7) variant call files (VCF). When comparing the concordance of BAM and VCF data for homozygous and heterozygous sites, the expected WGS sample appeared as a clear outlier (more consistent along both dimensions than any of the other 1249 WGS ROSMAP samples) for all single cell samples (Figure~\ref{fig:snRNA_cohort}).


\paragraph{Cell filtering metrics.}
Prior to cell type annotation, we performed a series of quality control steps on the aggregated counts matrix. First, we filtered cells based on $N_g$, the number of genes for each cell where counts $>0$, and kept cells for which $500 < N_g < 10000$. Next, we removed all cells with a high fraction of counts from mitochondrial-encoded genes. Mitochondrial fraction ($M_f$) is a commonly used per-cell metric to measure compromised nuclear integrity, with high fractions indicating low-quality nuclei, where $C_{mt}$ is the total counts of mitochondrially-encoded genes for a cell, $C_t$ is the total count of all genes for the same cell, and $M_f = \frac{C_{mt}}{C_t}$.

We fit a Gaussian mixture model (GMM) using sklearn's GaussianMixture implementation to $M'_f = \log_{10}(M_f + \epsilon)$, where $\epsilon$ is a small value added to $M_f$ to avoid taking the logarithm of zero. A GMM models the data as independently sampled from a mixture of $k$ Gaussian probability densities parameterized by a mean $\mu_k$, a variance $\sigma_k$, and a mixture weight $\pi_k$ indicating the proportion of the data derived from each component. The following log-likelihood function was maximized:
$ \ln[L(\theta|M'_f)] = \sum_{i=0}^{n} \ln \left( \sum_{j=0}^{k} \pi_j N(M'_{fi}|\mu_j, \sigma_j) \right) $
The model with $k = 5$ components had the lowest Bayesian information criterion (BIC) score (GridSearchCV from sklearn.preprocessing), where:
$ \text{BIC} = -2 \ln(L) + k \ln(n) $
where $L$ is the maximized log-likelihood of the model, and $n$ is the number of observations (cells). Finally, each cell $i$ is assigned a component in $k$ according to:
$ \text{argmax}_k \left[ \pi_k N(M'_{fi}|\mu_k, \sigma_k) \right] $
Cells assigned to the component $k$ with the highest mean $M'_f$ scores were presumed to constitute a population of low-quality cells and were removed from further analysis. This initial filtering removed approximately 20,000 cells.

Considering all remaining cells in marker-gene expression space, where marker genes include only known cell type-specific genes for the major human PFC cell types, including astrocytes (159 markers), excitatory neurons (113 markers), inhibitory neurons (83 markers), microglia (97 markers), oligodendrocytes (179 markers), OPCs (143 markers), and vascular cells (124 markers) (Reference 1; Table~\ref{tab:external_datasets}), normalized to total library size $NC_m = \frac{C_m}{C_t}$, where $NC_m$ and $C_m$ are respectively the normalized and unnormalized count values for a given marker gene $m$ and $C_t$ is the total counts of all genes for the same cell. Next, we performed a memory-efficient implementation of singular value decomposition (IncrementalPCA from sklearn.decomposition) to transform cells from the marker-gene space (mean-centered and unit-variance) into a lower dimensional space (top 50 principal components sorted by variance). Visually, the cells formed a number of Gaussian-like clusters when projected onto the first two principal components. Under the assumption that each Gaussian cluster represented a different cell type in the brain, we again fit a GMM, as described above, except this time parameterized by a covariance matrix $\Sigma_k$ instead of variance $\sigma_k$, to the projected data. The model with $k = 10$ and full covariance had the lowest BIC score. Each resulting cell cluster was enriched for a subset of major cell type markers in the brain, indicating clusters of astrocytes, microglia, OPCs, oligodendrocytes, excitatory neurons, inhibitory neurons, and a heterogeneous cluster of vascular cells.

To remove cells that were not well-explained by the GMM and likely represent low-quality cells, we next computed the per-cell log-probability given the model $L_i = \ln[P(x_i|\theta)]$, using Sklearn's GaussianMixture 'score\_samples' function, and removed cells with $L_i < -100$. We also removed two Gaussian clusters whose probability distributions constituted clear outliers compared to remaining clusters. The excluded cells had lower $C_t$ and higher $M_f$ compared to those that passed the log-likelihood filter, suggesting that the removed cells were indeed of low quality. As expected, when examining the data visually projected onto the first two principal components, this filtering removed many of the cells that were not visibly associated with a main Gaussian cluster. Together, this filtering removed an additional approximately 12,000 cells, leaving a total of 118,668 cells.

\paragraph{Gene filtering metrics.}
For the remaining downstream analysis we only considered genes that were both nuclear-encoded and protein-coding, which constituted a total of 19384 genes, based on annotation of ensembl GRCh38p12. 

\paragraph{Cell type annotations.}
To remove variance explained by sequencing batch and individual-of-origin, we first applied the Python implementation of the Harmony algorithm \supercite{Korsunsky2019-qz} with individual-of-origin as an indicator vector to the low-dimensional embedding of cells (first 50 principal components) remaining after the initial rounds of quality control described above. Next, we computed a neighborhood graph on the Harmony-corrected values in the PC embedding space, as implemented in the Scanpy Python package \supercite{Wolf2018-jx}, using default parameters. Finally, we applied the Leiden graph-clustering algorithm to cluster this neighborhood graph of cells, using the Scanpy implementation of the Leiden algorithm \supercite{Traag2019-xu}.

We used the Scanpy 'rank\_genes\_groups' function to compute top marker genes per Leiden cluster. Briefly, we assigned a major cell type label $ c $ to each Leiden cluster, where $ c \in \{\text{'Ex', 'In', 'Ast', 'Mic', 'Oli', 'Opc', 'Vascular'}\} $, by computing the average cell-type-specific marker gene enrichment per Leiden cluster. Specifically, this is a vector of cell type signatures $ S_c $ for each Leiden cluster, where 
$ S_c = \frac{1}{n} \sum_{i=0}^{n} \log_2\left(\frac{I_i^{\text{In}}}{I_i^{\text{Out}}}\right) $
where $ n $ is the total number of marker genes assigned to a cell type in $ c $ and $ I_i^{\text{In}} $ and $ I_i^{\text{Out}} $ indicate average gene expression values for a gene $ i $ for cells inside or outside a specific Leiden cluster, respectively. Then each Leiden cluster is assigned a label $ c $ by 
$ \text{argmax}_c(S_c) $.
Finally, we sub-clustered cells from each major cell type using the Leiden clustering algorithm and examined distributions of mitochondrial fractions $ M_f $ and total counts $ C_t $ among subclusters $ s $ of the same cell type. Clusters were removed if 
$ M_{f_s} > (2 \cdot \text{std}(M_f) + \overline{M_f}) $ 
or if 
$ |C_{t_s}| > (2 \cdot \text{std}(C_t) + \overline{C_t}) $, 
where $ M_{f_s} $ and $ C_{t_s} $ are respectively the mean $ M_f $ and $ C_t $ for all cells in a given Leiden cluster $ s $ and $ \overline{M_f} $ and $ \overline{C_t} $ are respectively the means of those values across all Leiden clusters, considering only clusters with the same cell type annotation $ c $, because variance in $ M_f $ and $ C_t $ across major cell types can be biologically explained. Manual inspection of the removed clusters revealed that they tended to have fewer cells and low individual-level representations, and were not well-connected in the graph.

\paragraph{Individual-level filtering.}
After all rounds of quality control as described above, we noted a subset of individuals ($N=6$) with very few cells ($<500$). These subjects were removed from further analysis, resulting in 24 control individuals and 12 ABCA7 LoF individuals. None of these individuals carried ABCA7 PTC variants, and removing them did not substantially alter the distribution of clinical variables across genotypes.

\paragraph{Differential gene expression.}
Summed (pseudo-bulked) gene expression values were computed by matrix multiplication $ X I $, where $ X $ is the gene x cell counts matrix and $ I $ is a cell x individual binary matrix indicating the individual-of-origin for each cell, resulting in 36 gene expression vectors for each of the six major cell types. For each cell type, only genes with a nonzero detection rate $ > 0.10 $ were considered for differential expression. Summed counts were normalized using the edgeR TMM method. The residual mean-variance trend not explained by the multivariate linear model (formalized below) was removed using Limma-Voom. Unknown sources of variance were captured in the model using surrogate variable analysis (SVA). Limma’s lmFit, eBayes, and topTable functions were then used to estimate differential gene expression statistics, as reported in Data~\ref{data:degs}. The following model was fit for each cell type:
$ G_i = \beta_0 \times \text{ABCA7LoF} + \beta_1 \times \text{msex} + \beta_2 \times \text{nft} + \beta_3 \times \text{amyloid} + \beta_4 \times \text{age\_death} + \beta_5 \times \text{PMI} + \beta_6 \times \text{batch} + \beta_7 \times \text{APOE4} + \beta_8 \times \text{SV0} $
$ G_i $ refers to a vector of expression profiles of size $ 1 \times 36 $ for a gene $ i $ in a given cell type. ABCA7LoF is a binary variable, encoding the presence of an ABCA7 variant predicted to cause loss of function (see Data~\ref{data:cohort_metadata}). See Supplementary Text for descriptions of the remaining variables included in the model. SV0 refers to the first surrogate variable estimated from the data. The exact number of surrogate variables per cell type to include as additive terms in the model was estimated using the num.sv() function in R. 

\paragraph{Gene-pathway projections.}
For each cell type, we computed a set of gene-wise scores quantifying the direction and statistical significance of gene expression changes (computed as part of the differential gene expression analysis) associated with ABCA7 LoF:
$ S = \text{sign}(\log_2\text{FC}) \times -\log_{10}(\text{p-value}) $
where $\log_2\text{FC} > 0$ indicates up-regulation in ABCA7 LoF vs control. Top differentially expressed genes per cell type ($|S| > 1.3$) were projected from 6-dimensional score space, where each dimension captures ABCA7 LoF perturbation scores in one of the major cell types (Ex, In, Ast, Mic, Oli, OPC), into two dimensions, using the UMAP algorithm (using the `umap` Python package). Gene scores that were not detected in >10\% of cells in a given cell type were set to 0.

We performed a grid search for Gaussian mixture parameters (parameter 1: number of components; parameter 2: covariance type) on the embedded cells (using the Python `sklearn` package) to assign genes to clusters in the 2D space. We proceeded with the model with the lowest BIC score, which had 15 components and a tied covariance matrix.

Each cluster was assigned representative pathway names by testing genes in that cluster for enrichment with Gene Ontology Biological Process pathways (Table~\ref{tab:external_datasets}) against the background of all genes in the embedding space, by hypergeometric enrichment (using the Python package `gseapy`). Pathways with an enrichment p-value < 0.01 were considered for cluster annotation.

Per-cell-type perturbation scores ($S_c$) for each cluster were computed as the average gene score $S$ (for a given cell type) for all genes in that cluster. The statistical significance of each cell type-specific cluster score was assessed by permuting cluster assignments (100,000 permutations).

\paragraph{Gene-set enrichment.}
Genes were rank-ordered based on their scores $S$ (see description in Gene-Pathway Projections). An R implementation of gene set enrichment analysis (GSEA) \supercite{Subramanian2005-gt} (fast gene set enrichment analysis, fGSEA) was run with 10,000 permutations to estimate the statistical overrepresentation of gene sets in the WikiPathways databases (Table~\ref{tab:external_datasets}) within high-scoring ($|S|$), differentially expressed genes. Gene sets with a minimum size of 5 and a maximum size of 1000 were considered.

\paragraph{Gene-pathway clustering using Kernighan-Lin heuristic.}
To reduce the solution's computational search space, we reformulated the gene-pathway association problem as a bipartite graph $G$ constructed from all the genes in the Leading Edge subset (LE) and their associated pathways. LE was defined as the set of 268 genes driving the enrichment signal for pathways that passed a significance threshold of $p < 0.05$ (fGSEA) in Con vs. ABCA7 LoF excitatory neurons. $G$ was constructed from an $n \times m$ unweighted adjacency matrix, where $n$ represented the number of LE genes and $m$ represented the number of pathways associated with four or more LE genes, as specified in the WikiPathways database.

We chose to group gene-pathways into clusters of approximately equal size, making this a graph partitioning problem. We found that removing this constraint made the grouping results highly susceptible to outliers (Supplementary Text; Figure~\ref{fig:benchmarking_clustering}C). Of the three graph partitioning algorithms tried, METIS and the Kernighan-Lin (K/L) algorithms had the lowest loss (Supplementary Text; Figure~\ref{fig:benchmarking_clustering}B). Both METIS and K/L achieved very comparable losses (within 1.8\% of each other, after $5.0 \times 10^4$ random initiations) and produced almost identical solutions (Rand index=0.98, after $5.0 \times 10^4$ random initiations) (Supplementary Text; Figure~\ref{fig:benchmarking_clustering}B, D-F). We proceeded with the K/L algorithm for gene-pathway groupings as we found this algorithm to perform consistently better than METIS across a wider range of graph sizes (not shown).

The K/L algorithm was implemented in Python (see GitHub Repository) based on its original paper \supercite{Kernighan1970-zl} and run with parameters set as $C=0$, $KL\_modified=True$, $random\_labels=True$, $unweighted=True$, and $K=50$ to partition $G$ into 8 groups. We performed $5.0 \times 10^4$ random initiations on $G$ and report the partitioning with the lowest loss among all initiations.

Gene-pathway graph layouts were computed using the `networkx` Python package with the spring layout algorithm, using 10,000 iterations. Layouts were visualized using the `matplotlib` `pyplot` package in Python. 

Representative pathways for each cluster were inferred from the graph by averaging the ABCA7 LoF perturbation scores $S$ for all genes in the cluster of interest sharing an edge with the pathway in question. Scores for pathways with intra-cluster degrees $\geq 5$ were reported in the figures. Manually picked subsets of genes with the largest scores ($|S| > 1$) were reported in the figures. All gene statistics are reported in Data~\ref{data:degs}, and cluster assignments are reported in Data~\ref{data:kl_clusters}.

\paragraph{Excitatory neuronal layer annotation.}
Excitatory neurons were annotated by cortical layer using previously published marker gene sets \supercite{He2017-dq} (Table~\ref{tab:external_datasets}). The normalized gene expression matrix (post-qualtiy control described above) for excitatory neurons was filtered to include only layer-specific marker genes and cells expressing at least 15\% of these genes. Dimensionality was reduced using iterative principal component analysis (iPCA), and batch effects from individual subjects were corrected using Harmony. A neighborhood graph was constructed based on these corrected components, followed by Leiden clustering to identify neuronal clusters. Clusters were annotated by calculating the average log-fold change of layer-specific marker genes. Clusters with significant enrichment (average log-fold change > 0.1) were labeled by cortical layer, while ambiguous clusters were  removed from further analysis. Layer 5 and 6 annotations were combined into a single 'L5/6' category. These annotations were confirmed using marker genes from an independent study \supercite{Maynard2021-mz} (Table~\ref{tab:external_datasets}). Per-layer differentially expressed genes were computed as described in the section "Differential Gene Expression," followed by gene set enrichment analysis of ABCA7 LoF-associated K/L clusters in excitatory neurons as described in the section "Gene Set Enrichment."

\paragraph{ABCA7 p.Ala1527Gly variant calling and gene-pathway clustering comparisons.}
We followed the same steps indicated in the section "Variant Calling and ROSMAP Subject Selection" to identify subjects who carried the p.Ala1527Gly variant and had snRNAseq performed on the PFC as part of a previous study. Differentially expressed genes were computed as described in the section "Differential Gene Expression," followed by gene set enrichment analysis of ABCA7 LoF-associated K/L clusters in excitatory neurons as described in the section "Gene Set Enrichment."

